import sys
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import NoSuchElementException, TimeoutException, WebDriverException
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

def main():
    # Set up Chrome options for headless execution (required for CI/CD environments)
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--window-size=1920,1080")

    # Initialize the WebDriver
    try:
        driver = webdriver.Chrome(options=chrome_options)
    except WebDriverException as e:
        print(f"Error initializing Chrome WebDriver: {e}", file=sys.stderr)
        sys.exit(1)

    try:
        # Open Google
        driver.get("https://www.google.com")
        print("Opened Google homepage.")

        # Accept cookies if the consent form appears (for EU users)
        try:
            consent_button = WebDriverWait(driver, 3).until(
                EC.element_to_be_clickable((By.XPATH, "//button[contains(., 'I agree') or contains(., 'Accept all')]"))
            )
            consent_button.click()
            print("Accepted cookies consent.")
        except TimeoutException:
            # Consent form did not appear
            pass

        # Locate the search box, enter 'selenium', and submit the search
        try:
            search_box = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.NAME, "q"))
            )
            search_box.clear()
            search_box.send_keys("selenium")
            search_box.send_keys(Keys.RETURN)
            print("Performed Google search for 'selenium'.")
        except (NoSuchElementException, TimeoutException):
            print("Search box not found on Google homepage.", file=sys.stderr)
            sys.exit(1)

        # Wait for the search results to load and display the results
        try:
            results = WebDriverWait(driver, 10).until(
                EC.presence_of_all_elements_located((By.CSS_SELECTOR, "div#search a"))
            )
        except TimeoutException:
            print("Search results did not load in time.", file=sys.stderr)
            sys.exit(1)

        # Extract the first ten URLs from the search results
        urls = []
        for link in results:
            href = link.get_attribute("href")
            if href and href.startswith("http"):
                urls.append(href)
            if len(urls) == 10:
                break

        print("First 10 URLs from Google search results for 'selenium':")
        for idx, url in enumerate(urls, 1):
            print(f"{idx}. {url}")

        if len(urls) < 10:
            print(f"Warning: Only found {len(urls)} URLs.", file=sys.stderr)

    except Exception as e:
        print(f"An unexpected error occurred: {e}", file=sys.stderr)
        sys.exit(1)
    finally:
        # Clean up and close the browser
        driver.quit()
        print("Closed the browser.")

if __name__ == "__main__":
    main()
