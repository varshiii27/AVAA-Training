name: Selenium Tests with Allure Report
 
on:

  push:

    branches:

      - main

  workflow_dispatch:
 
permissions:

  contents: write
 
jobs:

  selenium-tests:

    name: Selenium Test Job

    runs-on: ubuntu-latest
 
    steps:

      - name: Checkout Code

        uses: actions/checkout@v4
 
      - name: Set up Python

        uses: actions/setup-python@v5

        with:

          python-version: '3.10'
 
      - name: Install Dependencies

        run: |

          pip install --upgrade pip

          if [ -f requirements.txt ]; then

            pip install -r requirements.txt

          else

            pip install selenium webdriver-manager pytest allure-pytest

          fi
 
      - name: Run Selenium Tests (Generate Allure Results)

        run: |

          pytest test_google_search.py --alluredir=allure-results

        continue-on-error: true
 
      - name: Add Allure Executor Info

        run: |

          mkdir -p allure-results

          cat <<EOF > allure-results/executor.json

          {

            "name": "GitHub Actions",

            "type": "github",

            "buildName": "${{ github.workflow }}",

            "buildUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          }

          EOF
 
      - name: Install Allure CLI

        run: |

          sudo apt-get update

          sudo apt-get install -y default-jre

          curl -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz | sudo tar -xz -C /opt

          sudo ln -sf /opt/allure-2.27.0/bin/allure /usr/bin/allure
 
      - name: Generate Allure Report

        run: |

          allure generate allure-results --clean -o allure-report

      - name: Prepare Allure Report for GitHub Pages

        run: |

          touch allure-report/.nojekyll

          ls -la allure-report
 
 
      - name: Upload Allure Report Artifact

        if: always()

        uses: actions/upload-artifact@v4

        with:

          name: allure-report

          path: allure-report
 
      - name: Upload Screenshots

        if: always()

        uses: actions/upload-artifact@v4

        with:

          name: selenium-screenshots

          path: screenshots/

      - name: Ensure Allure Report Exists

        run: |

           mkdir -p allure-report

           allure generate allure-results --clean -o allure-report

           test -f allure-report/index.html || (echo "‚ùå Allure report not generated" && exit 1)
 
 
      - name: Deploy Allure Report to GitHub Pages

        if: always()

        uses: peaceiris/actions-gh-pages@v3

        with:

          github_token: ${{ secrets.GITHUB_TOKEN }}

          publish_branch: gh-pages

          publish_dir: allure-report
 
