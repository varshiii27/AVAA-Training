from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import NoSuchElementException, TimeoutException
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import sys

SEARCH_TERM = "selenium"
GOOGLE_URL = "https://www.google.com/"
RESULTS_SELECTOR = 'div#search a'
SEARCH_BOX_SELECTOR = 'input[name="q"]'
TIMEOUT = 10

def main():
    # Set up Chrome options for headless execution (GitHub CI compatible)
    chrome_options = Options()
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--window-size=1920,1080')

    driver = webdriver.Chrome(options=chrome_options)
    try:
        # Open Google
        driver.get(GOOGLE_URL)

        # Wait for the search box to be present
        try:
            search_box = WebDriverWait(driver, TIMEOUT).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, SEARCH_BOX_SELECTOR))
            )
        except TimeoutException:
            print("Search box not found within timeout.")
            sys.exit(1)

        # Enter the search term and submit
        search_box.clear()
        search_box.send_keys(SEARCH_TERM)
        search_box.send_keys(Keys.RETURN)

        # Wait for the results to load
        try:
            WebDriverWait(driver, TIMEOUT).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, RESULTS_SELECTOR))
            )
        except TimeoutException:
            print("Search results did not load in time.")
            sys.exit(1)

        # Assert the search box contains the search term after submission
        try:
            search_box_after = driver.find_element(By.CSS_SELECTOR, SEARCH_BOX_SELECTOR)
            assert search_box_after.get_attribute('value').lower() == SEARCH_TERM.lower(), (
                f"Search box does not contain the expected term: {SEARCH_TERM}"
            )
        except (NoSuchElementException, AssertionError) as e:
            print(f"Assertion failed: {e}")
            sys.exit(1)

        # Get the first ten URLs from the search results
        links = driver.find_elements(By.CSS_SELECTOR, RESULTS_SELECTOR)
        urls = []
        for link in links:
            href = link.get_attribute('href')
            # Filter out non-result links (e.g., images, navigation)
            if href and href.startswith('http'):
                urls.append(href)
            if len(urls) == 10:
                break

        # Assert that at least ten results are present
        assert len(urls) == 10, f"Expected at least 10 results, got {len(urls)}"

        # Print the first ten URLs
        print("First ten search result URLs:")
        for i, url in enumerate(urls, 1):
            print(f"{i}: {url}")

    except Exception as e:
        print(f"An error occurred: {e}")
        sys.exit(1)
    finally:
        # Properly close the browser
        driver.quit()

if __name__ == "__main__":
    main()
